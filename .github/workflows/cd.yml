name: Backend CD - Deployment (Dynamic Environments)

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - staging

jobs:
  deploy_production:
    name: CD - Backend Deploy (Prod)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate production environment file
        run: |
          cat <<'EOF' > .env.prod
          DEBUG=False
          APP_PORT=${{ secrets.APP_PORT || vars.APP_PORT || '8001' }}
          APP_NAME="${{ vars.APP_NAME || 'LEGAL WATCH DOG' }}"
          APP_VERSION=${{ vars.APP_VERSION || '1.0.0' }}
          ENVIRONMENT=production
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          LEGAL_WATCH_DOG_BASE_URL=${{ secrets.BASE_URL || vars.BASE_URL }}

          # Application URLs
          APP_URL=${{ secrets.APP_URL }}
          DEV_URL=${{ vars.DEV_URL || 'http://localhost:3000' }}

          # Database configuration
          DB_TYPE=${{ vars.DB_TYPE || 'postgresql' }}
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASS=${{ secrets.DB_PASS }}
          DB_NAME=${{ secrets.DB_NAME }}
          DATABASE_URL=${{ secrets.DATABASE_URL }}

          # Email configuration
          MAIL_MAILER=${{ vars.MAIL_MAILER || 'smtp' }}
          SMTP_SERVER=${{ secrets.SMTP_SERVER }}
          SMTP_PORT=${{ secrets.SMTP_PORT }}
          MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}
          MAIL_ENCRYPTION=${{ secrets.MAIL_ENCRYPTION }}
          EMAIL=${{ secrets.EMAIL }}
          MAIL_FROM_NAME="LEGAL WATCH DOG"

          # Redis configuration
          REDIS_URL=${{ secrets.REDIS_URL }}
          REDIS_RESEND_TTL=${{ secrets.REDIS_RESEND_TTL || vars.REDIS_RESEND_TTL || '300' }}
          REDIS_REGISTER_TTL=${{ secrets.REDIS_REGISTER_TTL || vars.REDIS_REGISTER_TTL || '600' }}

          # Secuirity / Auth
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_ALGORITHM=${{ secrets.JWT_ALGORITHM }}
          JWT_EXPIRY_HOURS=${{ secrets.JWT_EXPIRY_HOURS }}
          ACCESS_TOKEN_EXPIRATION=${{ secrets.ACCESS_TOKEN_EXPIRATION }}
          ENCRYPTION_KEY="${{ secrets.ENCRYPTION_KEY }}"

          # Testing config
          ALLOW_TEST_EMAIL_PROVIDERS=${{ vars.ALLOW_TEST_EMAIL_PROVIDERS || 'true' }}
          TEST_EMAIL_PROVIDERS="${{ vars.TEST_EMAIL_PROVIDERS || 'gmail.com' }}"

          # LLM (Gemini / AI Extraction)
          LLM_API_KEY=${{ secrets.LLM_API_KEY }}
          LLM_MODEL=${{ vars.LLM_MODEL || 'gemini-2.0-flash' }}
          LLM_API_URL=${{ vars.LLM_API_URL || 'https://generativelanguage.googleapis.com/v1/models/gemini-2.0-flash:generateContent' }}
          LLM_PROVIDER=${{ vars.LLM_PROVIDER || 'gemini' }}

          # Optional LLM Settings
          LLM_TEMPERATURE=${{ vars.LLM_TEMPERATURE || '0.1' }}
          LLM_MAX_TOKENS=${{ vars.LLM_MAX_TOKENS || '1000' }}

          # Gemini API Key (explicit)
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          MODEL_NAME=${{ vars.MODEL_NAME || 'gemini-2.0-flash-lite' }}

          # Billing Configuration
          TRIAL_DURATION_DAYS=${{ vars.TRIAL_DURATION_DAYS || '14' }}

          # Frontend URL (for Stripe redirects)
          FRONTEND_URL=${{ vars.FRONTEND_URL }}

          # Stripe Configuration
          STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_PUBLISHABLE_KEY=${{ secrets.STRIPE_PUBLISHABLE_KEY }}
          STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }}

          STRIPE_API_TIMEOUT=${{ vars.STRIPE_API_TIMEOUT || '10' }}
          STRIPE_RETRY_COUNT=${{ vars.STRIPE_RETRY_COUNT || '3' }}
          STRIPE_RETRY_BACKOFF=${{ vars.STRIPE_RETRY_BACKOFF || '0.5' }}

          MONTHLY_PRICE=${{ vars.MONTHLY_PRICE || '100' }}
          YEARLY_PRICE=${{ vars.YEARLY_PRICE || '1000' }}

          STRIPE_YEARLY_PRODUCT_ID=${{ secrets.STRIPE_YEARLY_PRODUCT_ID }}
          STRIPE_YEARLY_PRICE_ID=${{ secrets.STRIPE_YEARLY_PRICE_ID }}

          STRIPE_MONTHLY_PRICE_ID=${{ secrets.STRIPE_MONTHLY_PRICE_ID }}
          STRIPE_MONTHLY_PRODUCT_ID=${{ secrets.STRIPE_MONTHLY_PRODUCT_ID }}

          STRIPE_ONE_OFF_YEAR_PROD_ID=${{ secrets.STRIPE_ONE_OFF_YEAR_PROD_ID }}
          STRIPE_ONE_OFF_YEAR_PRICE_ID=${{ secrets.STRIPE_ONE_OFF_YEAR_PRICE_ID }}

          STRIPE_ONE_OFF_MONTH_PROD_ID=${{ secrets.STRIPE_ONE_OFF_MONTH_PROD_ID }}
          STRIPE_ONE_OFF_MONTH_PRICE_ID=${{ secrets.STRIPE_ONE_OFF_MONTH_PRICE_ID }}

          STRIPE_INVOICE_DURATION_DAYS=${{ vars.STRIPE_INVOICE_DURATION_DAYS || '3' }}
          STRIPE_CHECKOUT_SUCCESS_PATH=${{ vars.STRIPE_CHECKOUT_SUCCESS_PATH || '/billing/success' }}
          STRIPE_CHECKOUT_CANCEL_PATH=${{ vars.STRIPE_CHECKOUT_CANCEL_PATH || '/billing/cancel' }}

          # MinIO
          MINIO_ENDPOINT=${{ vars.MINIO_ENDPOINT || 'localhost:9000' }}
          MINIO_ACCESS_KEY=${{ secrets.MINIO_ACCESS_KEY || 'minioadmin' }}
          MINIO_SECRET_KEY=${{ secrets.MINIO_SECRET_KEY || 'minioadmin' }}
          MINIO_SECURE=${{ vars.MINIO_SECURE || 'False' }}

          # Scraping
          SCRAPE_MAX_RETRIES=${{ vars.SCRAPE_MAX_RETRIES || '5' }}
          SCRAPE_BASE_DELAY=${{ vars.SCRAPE_BASE_DELAY || '60' }}
          SCRAPE_MAX_DELAY=${{ vars.SCRAPE_MAX_DELAY || '3600' }}
          SCRAPE_DISPATCH_LOCK_TIMEOUT=${{ vars.SCRAPE_DISPATCH_LOCK_TIMEOUT || '60' }}
          SCRAPE_BATCH_SIZE=${{ vars.SCRAPE_BATCH_SIZE || '1000' }}

          # Invitation expiration
          INVITATION_TOKEN_EXPIRE_MINUTES=${{ vars.INVITATION_TOKEN_EXPIRE_MINUTES || '1440' }}

          # Microsoft OAuth
          MICROSOFT_REDIRECT_URI=${{ secrets.MICROSOFT_REDIRECT_URI }}
          MICROSOFT_TENANT_ID=${{ secrets.MICROSOFT_TENANT_ID }}
          MICROSOFT_CLIENT_SECRET=${{ secrets.MICROSOFT_CLIENT_SECRET }}
          MICROSOFT_CLIENT_ID=${{ secrets.MICROSOFT_CLIENT_ID }}
          MICROSOFT_USERINFO_ENDPOINT=${{ vars.MICROSOFT_USERINFO_ENDPOINT || 'https://graph.microsoft.com/v1.0/me' }}
          # MICROSOFT_SCOPES=https://graph.microsoft.com/User.Read,openid,email,profile
          MICROSOFT_OAUTH_REDIRECT_NEW_USER_URL=${{ secrets.MICROSOFT_OAUTH_REDIRECT_NEW_USER_URL || vars.MICROSOFT_OAUTH_REDIRECT_NEW_USER_URL }}
          MICROSOFT_OAUTH_REDIRECT_EXISTING_USER_URL=${{ secrets.MICROSOFT_OAUTH_REDIRECT_EXISTING_USER_URL || vars.MICROSOFT_OAUTH_REDIRECT_EXISTING_USER_URL }}
          MICROSOFT_OAUTH_STATE_TTL=${{ vars.MICROSOFT_OAUTH_STATE_TTL || '900' }}

          # Contact Us
          ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL || vars.ADMIN_EMAIL }}

          # Apple Auth
          APPLE_TEAM_ID=${{ secrets.APPLE_TEAM_ID }}
          APPLE_CLIENT_ID=${{ secrets.APPLE_CLIENT_ID }}
          APPLE_KEY_ID=${{ secrets.APPLE_KEY_ID }}
          APPLE_PRIVATE_KEY="${{ secrets.APPLE_PRIVATE_KEY }}"
          APPLE_CLIENT_SECRET_LIFETIME=${{ secrets.APPLE_CLIENT_SECRET_LIFETIME || vars.APPLE_CLIENT_SECRET_LIFETIME }}
          APPLE_REDIRECT_URI=${{ secrets.APPLE_REDIRECT_URI }}

          # Google OAuth
          GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_REDIRECT_URI=${{ vars.GOOGLE_REDIRECT_URI }}
          
          # Tavily configuration
          TAVILY_API_KEY=${{ secrets.TAVILY_API_KEY }}
          EOF

      - name: Set up SSH, copy env_file and Deploy
        env:
          SERVER_PASS: ${{ secrets.SERVER_PASS }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_IP: ${{ secrets.SERVER_IP }}
        run: |
          echo "access gained"
          echo "copying files to server..."

          sshpass -p "$SERVER_PASS" scp -o StrictHostKeyChecking=no \
            .env.prod \
            $SERVER_USER@$SERVER_IP:/tmp/backend_env

          echo "access gained"
          echo "deploying to production server..."

          sshpass -p "$SERVER_PASS" ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP << 'EOF'
            set -e

            REMOTE_DIR="/home/ifeanyinw/apps/backend/legal-watch-dog-be-prod"
            REPO_URL="https://github.com/hngprojects/legal-watch-dog-be"
            BRANCH="main"
            ENVIRONMENT="production"

            if [ ! -d "$REMOTE_DIR" ]; then
              mkdir -p $(dirname "$REMOTE_DIR")
              git clone -b "$BRANCH" "$REPO_URL" "$REMOTE_DIR"
            fi

            cd "$REMOTE_DIR"

            git checkout "$BRANCH"

            git fetch origin "$BRANCH"
            git reset --hard origin/"$BRANCH"

            mv /tmp/backend_env .env.prod || true

            if ! command -v uv &> /dev/null; then
              curl -LsSf https://astral.sh/uv/install.sh | sh
              export PATH="$HOME/.local/bin:$PATH"
            fi

            set -a
            source .env.prod
            set +a

            uv sync
            uv run alembic upgrade head

            PM2_APP_NAME="legal-watchdog-be-$ENVIRONMENT"

            if ! command -v pm2 &> /dev/null; then
              npm install -g pm2
            fi

            pm2 describe "$PM2_APP_NAME" > /dev/null 2>&1 && pm2 delete "$PM2_APP_NAME" || true
            pm2 start ecosystem.config.js --name "$PM2_APP_NAME" --update-env
            pm2 save

            pm2 startup systemd -u $(whoami) --hp $(echo $HOME) || true

            echo "${ENVIRONMENT} deployment complete!"
          EOF

      - name: Mark Deployment Result
        if: failure()
        run: echo "DEPLOY_FAILED=true" >> $GITHUB_ENV

  deploy_staging:
    name: CD - Backend Deploy (Staging)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/staging'
    environment: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate staging environment file
        run: |
          cat <<'EOF' > .env.stage
          # Application configuration
          DEBUG=True
          APP_PORT=${{ secrets.APP_PORT || vars.APP_PORT || '7001' }}
          APP_NAME="${{ vars.APP_NAME || 'LEGAL WATCH DOG' }}"
          APP_VERSION=${{ vars.APP_VERSION || '1.0.0' }}
          ENVIRONMENT=staging
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          LEGAL_WATCH_DOG_BASE_URL=${{ secrets.BASE_URL || vars.BASE_URL }}

          # Application URLs
          APP_URL=${{ secrets.APP_URL }}
          DEV_URL=${{ vars.DEV_URL || 'http://localhost:3000' }}

          # Database configuration
          DB_TYPE=${{ vars.DB_TYPE || 'postgresql' }}
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASS=${{ secrets.DB_PASS }}
          DB_NAME=${{ secrets.DB_NAME }}
          DATABASE_URL=${{ secrets.DATABASE_URL }}

          # Email configuration
          MAIL_MAILER=${{ vars.MAIL_MAILER || 'smtp' }}
          SMTP_SERVER=${{ secrets.SMTP_SERVER }}
          SMTP_PORT=${{ secrets.SMTP_PORT }}
          MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}
          MAIL_ENCRYPTION=${{ secrets.MAIL_ENCRYPTION }}
          EMAIL=${{ secrets.EMAIL }}
          MAIL_FROM_NAME="LEGAL WATCH DOG"

          # Redis configuration
          REDIS_URL=${{ secrets.REDIS_URL }}
          REDIS_RESEND_TTL=${{ secrets.REDIS_RESEND_TTL || vars.REDIS_RESEND_TTL || '300' }}
          REDIS_REGISTER_TTL=${{ secrets.REDIS_REGISTER_TTL || vars.REDIS_REGISTER_TTL || '600' }}

          # Secuirity / Auth
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_ALGORITHM=${{ secrets.JWT_ALGORITHM }}
          JWT_EXPIRY_HOURS=${{ secrets.JWT_EXPIRY_HOURS }}
          ACCESS_TOKEN_EXPIRATION=${{ secrets.ACCESS_TOKEN_EXPIRATION }}
          ENCRYPTION_KEY="${{ secrets.ENCRYPTION_KEY }}"

          # Testing config
          ALLOW_TEST_EMAIL_PROVIDERS=${{ vars.ALLOW_TEST_EMAIL_PROVIDERS || 'true' }}
          TEST_EMAIL_PROVIDERS="${{ vars.TEST_EMAIL_PROVIDERS || 'gmail.com' }}"

          # LLM (Gemini / AI Extraction)
          LLM_API_KEY=${{ secrets.LLM_API_KEY }}
          LLM_MODEL=${{ vars.LLM_MODEL || 'gemini-2.0-flash' }}
          LLM_API_URL=${{ vars.LLM_API_URL || 'https://generativelanguage.googleapis.com/v1/models/gemini-2.0-flash:generateContent' }}
          LLM_PROVIDER=${{ vars.LLM_PROVIDER || 'gemini' }}

          # Optional LLM Settings
          LLM_TEMPERATURE=${{ vars.LLM_TEMPERATURE || '0.1' }}
          LLM_MAX_TOKENS=${{ vars.LLM_MAX_TOKENS || '1000' }}

          # Gemini API Key (explicit)
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          MODEL_NAME=${{ vars.MODEL_NAME || 'gemini-2.0-flash-lite' }}

          # Billing Configuration
          TRIAL_DURATION_DAYS=${{ vars.TRIAL_DURATION_DAYS || '14' }}

          # Frontend URL (for Stripe redirects)
          FRONTEND_URL=${{ vars.FRONTEND_URL }}

          # Stripe Configuration
          STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_PUBLISHABLE_KEY=${{ secrets.STRIPE_PUBLISHABLE_KEY }}
          STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }}

          STRIPE_API_TIMEOUT=${{ vars.STRIPE_API_TIMEOUT || '10' }}
          STRIPE_RETRY_COUNT=${{ vars.STRIPE_RETRY_COUNT || '3' }}
          STRIPE_RETRY_BACKOFF=${{ vars.STRIPE_RETRY_BACKOFF || '0.5' }}

          MONTHLY_PRICE=${{ vars.MONTHLY_PRICE || '100' }}
          YEARLY_PRICE=${{ vars.YEARLY_PRICE || '1000' }}

          STRIPE_YEARLY_PRODUCT_ID=${{ secrets.STRIPE_YEARLY_PRODUCT_ID }}
          STRIPE_YEARLY_PRICE_ID=${{ secrets.STRIPE_YEARLY_PRICE_ID }}

          STRIPE_MONTHLY_PRICE_ID=${{ secrets.STRIPE_MONTHLY_PRICE_ID }}
          STRIPE_MONTHLY_PRODUCT_ID=${{ secrets.STRIPE_MONTHLY_PRODUCT_ID }}

          STRIPE_ONE_OFF_YEAR_PROD_ID=${{ secrets.STRIPE_ONE_OFF_YEAR_PROD_ID }}
          STRIPE_ONE_OFF_YEAR_PRICE_ID=${{ secrets.STRIPE_ONE_OFF_YEAR_PRICE_ID }}

          STRIPE_ONE_OFF_MONTH_PROD_ID=${{ secrets.STRIPE_ONE_OFF_MONTH_PROD_ID }}
          STRIPE_ONE_OFF_MONTH_PRICE_ID=${{ secrets.STRIPE_ONE_OFF_MONTH_PRICE_ID }}

          STRIPE_INVOICE_DURATION_DAYS=${{ vars.STRIPE_INVOICE_DURATION_DAYS || '3' }}
          STRIPE_CHECKOUT_SUCCESS_PATH=${{ vars.STRIPE_CHECKOUT_SUCCESS_PATH || '/billing/success' }}
          STRIPE_CHECKOUT_CANCEL_PATH=${{ vars.STRIPE_CHECKOUT_CANCEL_PATH || '/billing/cancel' }}

          # MinIO
          MINIO_ENDPOINT=${{ vars.MINIO_ENDPOINT || 'localhost:9000' }}
          MINIO_ACCESS_KEY=${{ secrets.MINIO_ACCESS_KEY || 'minioadmin' }}
          MINIO_SECRET_KEY=${{ secrets.MINIO_SECRET_KEY || 'minioadmin' }}
          MINIO_SECURE=${{ vars.MINIO_SECURE || 'False' }}

          # Scraping
          SCRAPE_MAX_RETRIES=${{ vars.SCRAPE_MAX_RETRIES || '5' }}
          SCRAPE_BASE_DELAY=${{ vars.SCRAPE_BASE_DELAY || '60' }}
          SCRAPE_MAX_DELAY=${{ vars.SCRAPE_MAX_DELAY || '3600' }}
          SCRAPE_DISPATCH_LOCK_TIMEOUT=${{ vars.SCRAPE_DISPATCH_LOCK_TIMEOUT || '60' }}
          SCRAPE_BATCH_SIZE=${{ vars.SCRAPE_BATCH_SIZE || '1000' }}

          # Invitation expiration
          INVITATION_TOKEN_EXPIRE_MINUTES=${{ vars.INVITATION_TOKEN_EXPIRE_MINUTES || '1440' }}

          # Microsoft OAuth
          MICROSOFT_REDIRECT_URI=${{ secrets.MICROSOFT_REDIRECT_URI }}
          MICROSOFT_TENANT_ID=${{ secrets.MICROSOFT_TENANT_ID }}
          MICROSOFT_CLIENT_SECRET=${{ secrets.MICROSOFT_CLIENT_SECRET }}
          MICROSOFT_CLIENT_ID=${{ secrets.MICROSOFT_CLIENT_ID }}
          MICROSOFT_USERINFO_ENDPOINT=${{ vars.MICROSOFT_USERINFO_ENDPOINT || 'https://graph.microsoft.com/v1.0/me' }}
          # MICROSOFT_SCOPES=https://graph.microsoft.com/User.Read,openid,email,profile
          MICROSOFT_OAUTH_REDIRECT_NEW_USER_URL=${{ secrets.MICROSOFT_OAUTH_REDIRECT_NEW_USER_URL || vars.MICROSOFT_OAUTH_REDIRECT_NEW_USER_URL }}
          MICROSOFT_OAUTH_REDIRECT_EXISTING_USER_URL=${{ secrets.MICROSOFT_OAUTH_REDIRECT_EXISTING_USER_URL || vars.MICROSOFT_OAUTH_REDIRECT_EXISTING_USER_URL }}
          MICROSOFT_OAUTH_STATE_TTL=${{ vars.MICROSOFT_OAUTH_STATE_TTL || '900' }}

          # Contact Us
          ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL || vars.ADMIN_EMAIL }}

          # Apple Auth
          APPLE_TEAM_ID=${{ secrets.APPLE_TEAM_ID }}
          APPLE_CLIENT_ID=${{ secrets.APPLE_CLIENT_ID }}
          APPLE_KEY_ID=${{ secrets.APPLE_KEY_ID }}
          APPLE_PRIVATE_KEY="${{ secrets.APPLE_PRIVATE_KEY }}"
          APPLE_CLIENT_SECRET_LIFETIME=${{ secrets.APPLE_CLIENT_SECRET_LIFETIME || vars.APPLE_CLIENT_SECRET_LIFETIME }}
          APPLE_REDIRECT_URI=${{ secrets.APPLE_REDIRECT_URI }}

          # Google OAuth
          GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_REDIRECT_URI=${{ vars.GOOGLE_REDIRECT_URI }}
          
          # Tavily configuration
          TAVILY_API_KEY=${{ secrets.TAVILY_API_KEY }}

          EOF

      - name: Set up SSH, copy env_file and Deploy
        env:
          SERVER_PASS: ${{ secrets.STAGING_PASS }}
          SERVER_USER: ${{ secrets.STAGING_USER }}
          SERVER_IP: ${{ secrets.STAGING_IP }}
        run: |
          echo "access gained"
          echo "copying files to server..."

          sshpass -p "$SERVER_PASS" scp -o StrictHostKeyChecking=no \
            .env.stage \
            $SERVER_USER@$SERVER_IP:/tmp/backend_env

          echo "access gained"
          echo "deploying to staging server..."

          sshpass -p "$SERVER_PASS" ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP << 'EOF'
            set -e

            REMOTE_DIR="/home/ifeanyinw/apps/backend/legal-watch-dog-be-staging"
            REPO_URL="https://github.com/hngprojects/legal-watch-dog-be"
            BRANCH="staging"
            ENVIRONMENT="staging"

            if [ ! -d "$REMOTE_DIR" ]; then
              mkdir -p $(dirname "$REMOTE_DIR")
              git clone "$REPO_URL" "$REMOTE_DIR"
            fi

            cd "$REMOTE_DIR"

            git fetch origin "$BRANCH"
            git reset --hard origin/"$BRANCH"

            mv /tmp/backend_env .env.stage || true

            if ! command -v uv &> /dev/null; then
              curl -LsSf https://astral.sh/uv/install.sh | sh
              export PATH="$HOME/.local/bin:$PATH"
            fi

            set -a
            source .env.stage
            set +a

            
            uv sync
            uv run alembic upgrade head

            PM2_APP_NAME="legal-watchdog-be-$ENVIRONMENT"

            if ! command -v pm2 &> /dev/null; then
              npm install -g pm2
            fi

            pm2 describe "$PM2_APP_NAME" > /dev/null 2>&1 && pm2 delete "$PM2_APP_NAME" || true
            pm2 start ecosystem.config.js --name "$PM2_APP_NAME" --update-env

            pm2 save

            pm2 startup systemd -u $(whoami) --hp $(echo $HOME) || true

            echo "${ENVIRONMENT} deployment complete!"
          EOF

      - name: Mark Deployment Result
        if: failure()
        run: echo "DEPLOY_FAILED=true" >> $GITHUB_ENV

  # -------------------------
  # 3. Slack Notification
  # -------------------------
  notify_slack:
    name: Notify Slack
    runs-on: [self-hosted]
    needs:
      - deploy_production
      - deploy_staging
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine deployment environment
        id: env_info
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          if [ "$BRANCH_NAME" == "main" ]; then
            echo "env_name=Production" >> $GITHUB_OUTPUT
            echo "env_emoji=üî¥" >> $GITHUB_OUTPUT
          elif [ "$BRANCH_NAME" == "staging" ]; then
            echo "env_name=Staging" >> $GITHUB_OUTPUT
            echo "env_emoji=üü°" >> $GITHUB_OUTPUT
          else
            echo "env_name=Development" >> $GITHUB_OUTPUT
            echo "env_emoji=üü¢" >> $GITHUB_OUTPUT
          fi

      - name: Set deployment status
        id: status
        run: |
          PRODUCTION_RESULT="${{ needs.deploy_production.result }}"
          STAGING_RESULT="${{ needs.deploy_staging.result }}"

          # Determine which deployment ran based on branch
          if [ "$PRODUCTION_RESULT" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "status_text=‚úÖ Production Backend API deployed successfully!" >> $GITHUB_OUTPUT
            echo "status_emoji=:white_check_mark:" >> $GITHUB_OUTPUT
          elif [ "$STAGING_RESULT" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "status_text=‚úÖ Staging Backend API deployed successfully!" >> $GITHUB_OUTPUT
            echo "status_emoji=:white_check_mark:" >> $GITHUB_OUTPUT
          elif [ "$PRODUCTION_RESULT" == "failure" ]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "status_text=‚ùå Production Backend API deployment failed!" >> $GITHUB_OUTPUT
            echo "status_emoji=:x:" >> $GITHUB_OUTPUT
          elif [ "$STAGING_RESULT" == "failure" ]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "status_text=‚ùå Staging Backend API deployment failed!" >> $GITHUB_OUTPUT
            echo "status_emoji=:x:" >> $GITHUB_OUTPUT
          elif [ "$PRODUCTION_RESULT" == "skipped" ] && [ "$STAGING_RESULT" == "skipped" ]; then
            echo "status=skipped" >> $GITHUB_OUTPUT
            echo "status_text=‚è≠Ô∏è Deployment skipped" >> $GITHUB_OUTPUT
            echo "status_emoji=:fast_forward:" >> $GITHUB_OUTPUT
          else
            echo "status=unknown" >> $GITHUB_OUTPUT
            echo "status_text=‚ö†Ô∏è Deployment status unknown" >> $GITHUB_OUTPUT
            echo "status_emoji=:warning:" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ steps.status.outputs.status }}
          text: |
            ${{ steps.status.outputs.status_text }}

            *Environment:* ${{ steps.env_info.outputs.env_emoji }} ${{ steps.env_info.outputs.env_name }}
            *Branch:* `${{ github.ref_name }}`
            *Triggered by:* ${{ github.actor }}
            *Commit:* ${{ github.event.head_commit.message }}

            *Deployment Results:*
            ${{ needs.deploy_production.result == 'success' && '‚úÖ Production: Deployed successfully' || needs.deploy_production.result == 'skipped' && '‚è≠Ô∏è Production: Skipped (not main branch)' || needs.deploy_production.result == 'failure' && '‚ùå Production: Deployment failed' || '' }}
            ${{ needs.deploy_staging.result == 'success' && '‚úÖ Staging: Deployed successfully' || needs.deploy_staging.result == 'skipped' && '‚è≠Ô∏è Staging: Skipped (not staging branch)' || needs.deploy_staging.result == 'failure' && '‚ùå Staging: Deployment failed' || '' }}
          author_name: Backend CI/CD Pipeline
          author_icon: ":gear:"
          fields: |
            [
              {
                "title": "Repository",
                "value": "${{ github.repository }}",
                "short": true
              },
              {
                "title": "Workflow",
                "value": "${{ github.workflow }}",
                "short": true
              }
            ]
          footer: Need help? Contact the development team or check the logs.
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
