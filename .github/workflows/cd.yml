name: Backend CD - Deployment (Dynamic Environments)

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - staging

jobs:
  deploy_staging:
    name: CD - Backend Deploy (Staging)
    runs-on: [self-hosted]
    if: github.ref == 'refs/heads/staging'
    environment: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate staging environment file
        run: |
          cat <<'EOF' > .env.stage
          # Application configuration
          DEBUG=True
          APP_PORT=${{ secrets.APP_PORT || vars.APP_PORT || '7001' }}
          APP_NAME="${{ vars.APP_NAME || 'LEGAL WATCH DOG' }}"
          APP_VERSION=${{ vars.APP_VERSION || '1.0.0' }}
          ENVIRONMENT=staging
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          LEGAL_WATCH_DOG_BASE_URL=${{ secrets.BASE_URL || vars.BASE_URL }}
          
          # Application URLs
          APP_URL="${{ vars.APP_URL || 'https://staging.minamoto.emerj.net' }}"
          DEV_URL="${{ vars.DEV_URL || 'http://localhost:3000' }}"

          # Database configuration
          DB_TYPE=${{ vars.DB_TYPE || 'postgresql' }}
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASS=${{ secrets.DB_PASS }}
          DB_NAME=${{ secrets.DB_NAME }}
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          
          # Email configuration
          MAIL_MAILER=${{ vars.MAIL_MAILER || 'smtp' }}
          SMTP_SERVER=${{ secrets.SMTP_SERVER }}
          SMTP_PORT=${{ secrets.SMTP_PORT }}
          MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}
          MAIL_ENCRYPTION=${{ secrets.MAIL_ENCRYPTION }}
          EMAIL=${{ secrets.EMAIL }}
          MAIL_FROM_NAME="LEGAL WATCH DOG"

          # Redis configuration
          REDIS_URL=${{ secrets.REDIS_URL }}
          REDIS_RESEND_TTL=${{ secrets.REDIS_RESEND_TTL || vars.REDIS_RESEND_TTL || '300' }}
          REDIS_REGISTER_TTL=${{ secrets.REDIS_REGISTER_TTL || vars.REDIS_REGISTER_TTL || '600' }}

          # Secuirity / Auth
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_ALGORITHM=${{ secrets.JWT_ALGORITHM }}
          JWT_EXPIRY_HOURS=${{ secrets.JWT_EXPIRY_HOURS }}
          ACCESS_TOKEN_EXPIRATION=${{ secrets.ACCESS_TOKEN_EXPIRATION }}
          ENCRYPTION_KEY="${{ secrets.ENCRYPTION_KEY }}"
          
          # Testing config
          ALLOW_TEST_EMAIL_PROVIDERS=${{ vars.ALLOW_TEST_EMAIL_PROVIDERS || 'true' }}
          TEST_EMAIL_PROVIDERS="${{ vars.TEST_EMAIL_PROVIDERS || 'gmail.com' }}"

          # LLM (Gemini / AI Extraction)
          LLM_API_KEY=${{ secrets.LLM_API_KEY }}
          LLM_MODEL=${{ vars.LLM_MODEL || 'gemini-2.0-flash' }}
          LLM_API_URL=${{ vars.LLM_API_URL || 'https://generativelanguage.googleapis.com/v1/models/gemini-2.0-flash:generateContent' }}
          LLM_PROVIDER=${{ vars.LLM_PROVIDER || 'gemini' }}

          # Optional LLM Settings
          LLM_TEMPERATURE=${{ vars.LLM_TEMPERATURE || '0.1' }}
          LLM_MAX_TOKENS=${{ vars.LLM_MAX_TOKENS || '1000' }}

          # Gemini API Key (explicit)
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}

          EOF


      - name: Set up SSH, copy env_file and Deploy
        env:
          SERVER_PASS: ${{ secrets.STAGING_PASS }}
          SERVER_USER: ${{ secrets.STAGING_USER }}
          SERVER_IP: ${{ secrets.STAGING_IP }}
        run: |
          echo "access gained"
          echo "copying files to server..."

          sshpass -p "$SERVER_PASS" scp -o StrictHostKeyChecking=no \
            .env.stage \
            $SERVER_USER@$SERVER_IP:/tmp/backend_env

          echo "access gained"
          echo "deploying to staging server..."

          sshpass -p "$SERVER_PASS" ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP << 'EOF'
            set -e

            REMOTE_DIR="/home/ifeanyinw/apps/backend/legal-watch-dog-be-staging"
            REPO_URL="https://github.com/hngprojects/legal-watch-dog-be"
            BRANCH="staging"
            ENVIRONMENT="staging"

            if [ ! -d "$REMOTE_DIR" ]; then
              mkdir -p $(dirname "$REMOTE_DIR")
              git clone "$REPO_URL" "$REMOTE_DIR"
            fi

            cd "$REMOTE_DIR"

            git fetch origin "$BRANCH"
            git reset --hard origin/"$BRANCH"

            mv /tmp/backend_env .env.stage || true
          
            if ! command -v uv &> /dev/null; then
              curl -LsSf https://astral.sh/uv/install.sh | sh
              export PATH="$HOME/.local/bin:$PATH"
            fi

            set -a
            source .env.stage
            set +a

            
            uv sync
            uv run alembic upgrade head

            PM2_APP_NAME="legal-watchdog-be-$ENVIRONMENT"

            if ! command -v pm2 &> /dev/null; then
              npm install -g pm2
            fi
          
            pm2 describe "$PM2_APP_NAME" > /dev/null 2>&1 && pm2 delete "$PM2_APP_NAME" || true
            pm2 start ecosystem.config.js --name "$PM2_APP_NAME" --update-env

            pm2 save
          
            pm2 startup systemd -u $(whoami) --hp $(echo $HOME) || true

            echo "${ENVIRONMENT} deployment complete!"
          EOF


  # -------------------------
  # 3. Slack Notification
  # -------------------------
  notify_slack:
    name: Notify Slack
    runs-on: [self-hosted]
    needs:
      - deploy_staging
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine deployment environment
        id: env_info
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          if [ "$BRANCH_NAME" == "main" ]; then
            echo "env_name=Production" >> $GITHUB_OUTPUT
            echo "env_emoji=üî¥" >> $GITHUB_OUTPUT
          elif [ "$BRANCH_NAME" == "staging" ]; then
            echo "env_name=Staging" >> $GITHUB_OUTPUT
            echo "env_emoji=üü°" >> $GITHUB_OUTPUT
          else
            echo "env_name=Development" >> $GITHUB_OUTPUT
            echo "env_emoji=üü¢" >> $GITHUB_OUTPUT
          fi

      - name: Set deployment status
        id: status
        run: |
          STAGING_RESULT="${{ needs.deploy_staging.result }}"
          
          if [ "$STAGING_RESULT" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "status_text=‚úÖ Backend API deployed successfully!" >> $GITHUB_OUTPUT
            echo "status_emoji=:white_check_mark:" >> $GITHUB_OUTPUT
          elif [ "$STAGING_RESULT" == "skipped" ]; then
            echo "status=skipped" >> $GITHUB_OUTPUT
            echo "status_text=‚è≠Ô∏è Deployment skipped" >> $GITHUB_OUTPUT
            echo "status_emoji=:fast_forward:" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "status_text=‚ùå Backend API deployment failed!" >> $GITHUB_OUTPUT
            echo "status_emoji=:x:" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ steps.status.outputs.status }}
          text: |
            ${{ steps.status.outputs.status_text }}
            
            *Environment:* ${{ steps.env_info.outputs.env_emoji }} ${{ steps.env_info.outputs.env_name }}
            *Branch:* `${{ github.ref_name }}`
            *Triggered by:* ${{ github.actor }}
            *Commit:* ${{ github.event.head_commit.message }}
            
            ${{ needs.deploy_staging.result == 'success' && '‚úÖ Test Environment: Deployed successfully' || needs.deploy_staging.result == 'skipped' && '‚è≠Ô∏è Test Environment: Skipped (not staging branch)' || needs.deploy_staging.result == 'failure' && '‚ùå Test Environment: Deployment failed' || '' }}
          author_name: Backend CI/CD Pipeline
          author_icon: ':gear:'
          fields: |
            [
              {
                "title": "Repository",
                "value": "${{ github.repository }}",
                "short": true
              },
              {
                "title": "Workflow",
                "value": "${{ github.workflow }}",
                "short": true
              }
            ]
          footer: Need help? Contact the development team or check the logs.
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}